import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
df = pd.read_csv('credit_default.csv')
df.head()
df = df[(df['person_age'] <= 90) & (df['person_age'] >= 18)]
df.info()
#Подивитися на датасет: .head (), .info (), .dtypes, .describe ()
# Перегляд перших 5 записів
print(df.head())

# Загальна інформація про датасет
print(df.info())

# Типи даних по кожній колонці
print(df.dtypes)

# Статистичне зведення для числових ознак
print(df.describe())

###Для кращого розуміння даних провести візуальний та розвідковий аналіз даних:
###Порівняння характеристик добросовісних та недобросовісних позичальників:
###Порівняйте розподіл віку та річного доходу для добросовісних та недобросовісних позичальників.
###Зробіть висновки щодо можливих залежностей між віком, річним доходом та ймовірністю несплати кредиту.

# Графік розподілу віку
plt.figure(figsize=(12, 5))
sns.histplot(data=df, x="person_age", hue="loan_status", bins=30, kde=True, palette="husl")
plt.title("Розподіл віку позичальників за статусом кредиту")
plt.xlabel("Вік")
plt.ylabel("Кількість")
plt.legend(title="loan_status", labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Графік показує розподіл віку позичальників за статусом кредиту. Він містить два типи позичальників:
#\"0 - Сплачено\" (бірюзова лінія) — позичальники, які погасили свої кредити.
#\"1 - Не сплачено\" (рожева лінія) — позичальники, які не погасили кредити.
# Основні спостереження:
#Пік серед молодих позичальників (приблизно 20–30 років) — ця вікова група має найбільшу кількість кредитів, як сплачених,
#так і несплачених. Це може вказувати на активне кредитування молоді, можливо, через їхню потребу у фінансуванні навчання, житла чи підприємницьких ініціатив.
#Рожевий пік вищий за бірюзовий — свідчить про те, що серед молодих людей більше тих, хто не погасив кредит.
#Це може означати певні проблеми з фінансовою стабільністю або плануванням бюджету у цій віковій групі.
#Зменшення кількості позичальників із віком — старші люди рідше беруть кредити або мають вищі шанси їх погасити.
#Це може пояснюватися стабільнішим доходом або більш обережним підходом до фінансових зобов’язань.


# Графік розподілу доходу
plt.figure(figsize=(12, 5))
sns.histplot(data=df[df['person_income'] < 250000], x="person_income", hue="loan_status", bins=30, kde=True, palette="coolwarm")
plt.title("Розподіл річного доходу позичальників за статусом кредиту")
plt.xlabel("Річний дохід")
plt.ylabel("Кількість")
plt.legend(title="loan_status", labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Це гістограма, яка показує розподіл річного доходу позичальників за статусом кредиту. Вона містить два типи позичальників:
#\"0 - Сплачено\" (оранжева лінія) — позичальники, які погасили свої кредити.
#\"1 - Не сплачено\" (синя лінія) — позичальники, які не погасили кредити.
#Основні спостереження:
#1 Пік для несплачених кредитів навколо $50,000 річного доходу Позичальники з несплаченими кредитами мають тенденцію до вищого річного доходу,
#порівняно з тими, хто погасив кредит. Це може свідчити про те, що високий дохід не завжди гарантує надійне погашення боргу.
#2 Рівномірніший розподіл для тих, хто сплатив кредит Позичальники, які погасили кредит, мають розосереджений дохід, без вираженого піку.
#Це може означати, що фінансова відповідальність не залежить тільки від рівня доходу, а й від інших факторів, таких як фінансова грамотність та стабільність джерел доходу.
#3 Високий дохід ≠ менший фінансовий ризик Важливо звернути увагу, що навіть серед високодохідних позичальників є значна частка боржників.
#Це може бути наслідком нестабільних доходів, ризикованих фінансових рішень або високих витрат, що перевищують заробіток.


### Вивчення впливу розміру кредиту та відсоткової ставки на сплату кредиту:
###Дослідіть залежність між розміром кредиту та відсотковою ставкою.
# Фільтр для видалення пропусків у відсотковій ставці
df_filtered = df.dropna(subset=['loan_int_rate'])

# Графік розсіювання: сума кредиту vs. відсоткова ставка
plt.figure(figsize=(10, 6))
sns.scatterplot(data=df_filtered, x='loan_amnt', y='loan_int_rate', hue='loan_status', palette='Set1', alpha=0.6)
plt.title('Залежність між розміром кредиту та відсотковою ставкою')
plt.xlabel('Розмір кредиту')
plt.ylabel('Відсоткова ставка (%)')
plt.legend(title='loan_status', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()

#Це діаграма розсіювання, яка показує залежність між розміром кредиту та відсотковою ставкою. Використано два кольори для позначення статусу кредиту:
#Синій (0 - Сплачено) — кредити, які були погашені.
#Червоний (1 - Не сплачено) — кредити, які залишились несплаченими.
#Червоні точки розподілені по всьому діапазону, що означає, що несплачений кредит може мати будь-який розмір і ставку,
#але велика їх частина зосереджена у нижніх діапазонах (де кредит менший).
#Можлива залежність між високими ставками і несплаченими кредитами — деякі червоні точки зосереджені в зоні високих процентних ставок (15%+),
#що може свідчити про підвищений ризик для позичальників із високими ставками.
#Висновки:
#Малі кредити видаються частіше, але вони також мають різний рівень погашення.
#Висока ставка може корелювати з вищим ризиком неповернення кредиту, що може бути важливим сигналом для фінансових установ.
#Загальна кластеризація навколо нижчих кредитів і ставок може свідчити про те, що більші кредити менш доступні, а високі ставки збільшують ймовірність несплати.

###Визначте, які категорії позичальників  частіше відмовляються від сплати кредиту при високих відсоткових ставках.
plt.figure(figsize=(10, 6))
sns.boxplot(data=df_filtered[df_filtered['person_income'] < 250000],
            x='loan_status',
            y='person_income',
            hue='loan_status',
            palette='pastel',
            dodge=False)
plt.title('Розподіл доходу позичальників за статусом кредиту')
plt.xlabel('Статус кредиту (0 - Сплачено, 1 - Не сплачено)')
plt.ylabel('Річний дохід')
plt.legend([],[], frameon=False)
plt.show()
#Це скринькова діаграма (box plot), яка показує розподіл річного доходу позичальників за статусом кредиту:
#0 - Сплачено (синя діаграма) — позичальники, які успішно погасили свої кредити.
#1 - Не сплачено (оранжева діаграма) — позичальники, які не змогли погасити кредити.
#Висновки:
#Вищий дохід загалом корелює з більшою ймовірністю погашення кредиту, але не є абсолютним фактором.
#Боржники з низьким доходом частіше мають труднощі з поверненням кредиту,
#тому може бути корисним впровадження гнучких умов кредитування або програм фінансової підтримки.
#Наявність аномалій (outliers) серед обох груп В обох категоріях є значна кількість позичальників з дуже високими доходами,
#але навіть серед них зустрічаються випадки несплачених кредитів. Це може вказувати на інші фактори, крім доходу, які впливають на здатність до погашення боргу.

#plt.figure(figsize=(12, 6))
sns.boxplot(data=df_filtered[df_filtered['person_income'] < 250000],
            x='person_home_ownership',
            y='person_income',
            hue='loan_status',
            palette='Set3')
plt.title('Річний дохід за типом житла і статусом сплати кредиту')
plt.xlabel('Тип володіння житлом')
plt.ylabel('Річний дохід')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Висновки:
#Тип житла впливає на фінансову стабільність і ризик несплати кредиту. Позичальники з власним житлом мають більше ресурсів для виплат,
#тоді як орендарі стикаються з більшим фінансовим навантаженням.
#Іпотечні позичальники можуть бути на межі фінансових ризиків: високий дохід є, але боржники можуть мати труднощі через великі витрати на житло.
#Аналіз цих даних може бути корисним для фінансових установ при оцінці платоспроможності клієнтів залежно від їх житлових умов.


###Аналіз впливу кредитного рейтингу та призначення кредиту на ризик неповернення кредиту:
###Порівняйте відсоток несплати кредиту для різних категорій кредитного рейтингу та призначення кредиту.
# Частка несплат для кожного кредитного рейтингу
grade_default_rate = df.groupby('loan_grade')['loan_status'].mean().sort_values()

plt.figure(figsize=(10, 6))
sns.barplot(x=grade_default_rate.index, y=grade_default_rate.values, hue=grade_default_rate.index, palette='Reds', legend=False)
plt.title('Частка несплати кредиту за кредитним рейтингом')
plt.xlabel('Кредитний рейтинг')
plt.ylabel('Частка несплат')
plt.ylim(0, 1)
plt.show()
#Висновки:
#Високий кредитний рейтинг значно зменшує ризик несплати.
#Високий кредитний рейтинг значно зменшує ризик несплати.
#Фінансові установи можуть використовувати цей аналіз для формування політики видачі кредитів, впроваджуючи додаткові умови для позичальників із низькими рейтингами.

###Зробіть висновки про те, як ці фактори впливають на ризик неповернення кредиту.
# Частка несплат за призначенням кредиту
intent_default_rate = df.groupby('loan_intent')['loan_status'].mean().sort_values()

plt.figure(figsize=(12, 6))
sns.barplot(x=intent_default_rate.index, y=intent_default_rate.values, hue=intent_default_rate.index, palette='Blues', legend=False)
plt.title('Частка несплати кредиту за призначенням')
plt.xlabel('Призначення кредиту')
plt.ylabel('Частка несплат')
plt.ylim(0, 1)
plt.show()
#DEBT CONSOLIDATION має найвищу частку несплат
#Позичальники, які брали кредит для консолідації боргів, мають найвищий рівень неповернення.
#Позичальники, які брали кредит для консолідації боргів, мають найвищий рівень неповернення.
#
#VENTURE має найнижчу частку несплат
#Позичальники, які брали кредит на підприємницькі цілі (VENTURE), мають найменшу частку несплат.
#Це може свідчити про кращу фінансову дисципліну серед підприємців або успішніші фінансові рішення.
#
#MEDICAL та PERSONAL займають середні позиції
#Кредити на медичні потреби (MEDICAL) та особисті витрати (PERSONAL) мають помірний ризик несплати.
#Це може означати, що позичальники часто використовують ці кредити в критичних ситуаціях, що може впливати на їхню здатність сплачувати борги.
#
#EDUCATION знаходиться ближче до нижчих рівнів несплати
#Позичальники, які брали кредит на освіту (EDUCATION), мають порівняно низький рівень несплат.
#Це може свідчити про довгострокові фінансові перспективи, оскільки освіта часто підвищує доходи в майбутньому.
#


####Аналіз взаємозв'язку між кредитною історією та ризиком несплати:
###Порівняйте ризик несплати кредиту для позичальників з та без кредитної історії.
# Частка несплат для позичальників з / без запису про дефолт
default_history_rate = df.groupby('cb_person_default_on_file')['loan_status'].mean()

plt.figure(figsize=(8, 5))
sns.barplot(x=default_history_rate.index,
            y=default_history_rate.values,
            hue=default_history_rate.index,
            palette='Set1',
            legend=False)
plt.title('Ризик несплати залежно від наявності дефолту у кредитній історії')
plt.xlabel('Наявність дефолту в історії')
plt.ylabel('Частка несплат')
plt.ylim(0, 1)
plt.show()

#Основні спостереження:
#Позичальники з дефолтом у кредитній історії (Y) мають удвічі більшу частку несплат
#У групі без дефолту ("N") частка несплат — приблизно 0.2.
#У групі з дефолтом ("Y") частка несплат досягає 0.4.
#
#Позичальники, які мали проблеми з виплатами у минулому, з вищою ймовірністю не погашають нові кредити.


###Зробіть висновки щодо впливу тривалості кредитної історії на ймовірність відмови від сплати кредиту.
plt.figure(figsize=(10, 6))
sns.histplot(data=df, x='cb_person_cred_hist_length', hue='loan_status', multiple='stack', bins=20, palette='Set2')
plt.title('Розподіл тривалості кредитної історії за статусом кредиту')
plt.xlabel('Кількість років кредитної історії')
plt.ylabel('Кількість позичальників')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Висновки:
#Позичальники з короткою кредитною історією становлять більший ризик для фінансових установ через вищу ймовірність несплати.
#Довготривала кредитна історія може бути фактором фінансової надійності—чим більше років у системі, тим стабільніше платіжна дисципліна.
#Банки можуть використовувати ці дані для оцінки ризиків і коригувати умови кредитування для нових позичальників.



###Аналіз впливу річного доходу на величину кредиту та його сплату:
###Дослідіть, чи існує зв'язок між річним доходом та розміром кредиту.
plt.figure(figsize=(10, 6))
sns.scatterplot(data=df[df['person_income'] < 250000],
                x='person_income', y='loan_amnt', hue='loan_status', palette='Set2', alpha=0.6)
sns.regplot(data=df[df['person_income'] < 250000],
            x='person_income', y='loan_amnt', scatter=False, color='black')
plt.title('Залежність розміру кредиту від річного доходу')
plt.xlabel('Річний дохід')
plt.ylabel('Розмір кредиту')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Висновки:
#Розмір кредиту зростає разом із доходом, але ризик несплати присутній у всіх категоріях доходу.
#Позичальники з низьким доходом мають більшу ймовірність несплати, що може вимагати додаткової оцінки платоспроможності перед видачею кредиту.
#Фінансові установи можуть використовувати ці дані для коригування кредитної політики, зокрема,
#впроваджуючи програми для стабілізації платежів для низькодохідних позичальників.


###Визначте, як річний дохід впливає на розмір кредитного платежу та ймовірність відмови від сплати кредиту.
plt.figure(figsize=(10, 6))
sns.scatterplot(data=df[df['person_income'] < 250000],
                x='person_income', y='loan_percent_income', hue='loan_status', palette='coolwarm', alpha=0.5)
plt.title('Залежність кредитного навантаження від річного доходу')
plt.xlabel('Річний дохід')
plt.ylabel('% кредиту до доходу')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Висновки:
#Високе кредитне навантаження корелює з вищим ризиком несплати, особливо серед позичальників із низьким доходом.
#Позичальники з високим доходом мають краще контрольоване кредитне навантаження, що може означати вищу фінансову стабільність.
#Фінансові установи можуть використовувати цей аналіз для вдосконалення кредитної політики, запроваджуючи додаткові механізми оцінки ризиків.


###Аналіз тривалості кредитної історії та її вплив на сплату кредиту:
###Дослідіть, як тривалість кредитної історії впливає на величину кредиту та ймовірність несплати.
plt.figure(figsize=(10, 6))
sns.scatterplot(data=df, x='cb_person_cred_hist_length', y='loan_amnt', hue='loan_status', palette='Set1', alpha=0.5)
plt.title('Залежність між тривалістю кредитної історії та розміром кредиту')
plt.xlabel('Кількість років кредитної історії')
plt.ylabel('Розмір кредиту')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()

#Висновки:
#Тривалість кредитної історії не є ключовим фактором успішного погашення кредиту, хоча вона впливає на рівень доступу до кредитних ресурсів.
#Розмір кредиту більш залежний від загальної фінансової спроможності позичальника, ніж від тривалості його історії.
#Фінансові установи можуть використовувати ці дані для уточнення кредитної політики, розглядаючи додаткові параметри кредитоспроможності.

###Зробіть висновки щодо того, чи існує залежність між тривалістю кредитної історії та ризиком несплати кредиту.
plt.figure(figsize=(10, 6))
sns.histplot(data=df, x='cb_person_cred_hist_length', hue='loan_status', multiple='stack', bins=20, palette='Set2')
plt.title('Розподіл тривалості кредитної історії за статусом кредиту')
plt.xlabel('Тривалість кредитної історії (роки)')
plt.ylabel('Кількість позичальників')
plt.legend(title='Статус кредиту', labels=["0 - Сплачено", "1 - Не сплачено"])
plt.show()
#Так, існує залежність між тривалістю кредитної історії та ризиком несплати кредиту. Коротка історія (до 5 років) пов’язана з вищим ризиком несплати,
#тоді як довга кредитна історія (понад 5 років) демонструє нижчий рівень фінансових проблем.
#Ці дані можуть бути корисними для кредитних установ, оскільки вони можуть враховувати тривалість кредитної історії як один із факторів оцінки ризиків позичальника.


###Реалізувати алгоритми логістичної регресії, KNN та SVM для класифікації позичальників банку. Перевірити якість класифікаторів. ЗРОБИТИ ВИСНОВКИ
##Підготовка даних
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix

# Видаляємо пропущені значення
df_clean = df.dropna()

# Закодуємо категоріальні змінні
df_encoded = pd.get_dummies(df_clean, drop_first=True)

# Розділяємо змінні
X = df_encoded.drop('loan_status', axis=1)
y = df_encoded['loan_status']

# Масштабуємо дані
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# Тренувальна та тестова вибірки
X_train, X_test, y_train, y_test = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

##Моделі
from sklearn.linear_model import LogisticRegression
from sklearn.neighbors import KNeighborsClassifier
from sklearn.svm import SVC

# Логістична регресія
log_reg = LogisticRegression()
log_reg.fit(X_train, y_train)
y_pred_log = log_reg.predict(X_test)

# KNN
knn = KNeighborsClassifier(n_neighbors=5)
knn.fit(X_train, y_train)
y_pred_knn = knn.predict(X_test)

# SVM
svm = SVC()
svm.fit(X_train, y_train)
y_pred_svm = svm.predict(X_test)

##Оцінка моделей
print("=== Логістична регресія ===")
print(classification_report(y_test, y_pred_log))

print("=== KNN ===")
print(classification_report(y_test, y_pred_knn))

print("=== SVM ===")
print(classification_report(y_test, y_pred_svm))

#Precision класу показує, яку частку з усіх передбачених позитивних випадків (боржників) модель передбачила правильно.
#Recall класу показує, яку частку з усіх реальних боржників модель змогла правильно ідентифікувати.
#F1-score — це метрика, яка оцінює баланс між Precision і Recall, тобто точністю і повнотою класифікатора.


#1. Логістична регресія
#Точність (accuracy): 88%
#Precision класу 1 (боржники): 78%
#Recall класу 1: 58%
#F1-score класу 1: 66%
#Хороша загальна точність, але низький recall для боржників означає, що алгоритм часто не виявляє несплачені кредити.
#Це може бути проблемою, якщо важливіше знайти всіх боржників.
#
#2. KNN (K-Nearest Neighbors)
#Точність (accuracy): 90%
#Precision класу 1: 87%
#Recall класу 1: 62%
#F1-score класу 1: 72%
#Покращений precision порівняно з логістичною регресією.
#Recall для боржників трохи вищий (62%), але все ще не ідеальний.
#
#3. SVM (Support Vector Machine)
#Точність (accuracy): 91%
#Precision класу 1: 93%
#Recall класу 1: 63%
#F1-score класу 1: 75%
#Найкраща загальна точність (91%).
#Precision для боржників найвищий (93%), що означає найменшу кількість помилкових тривог.
#Покращений F1-score порівняно з KNN і логістичною регресією.